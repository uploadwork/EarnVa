<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Earnings Dashboard</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#FFE85C; color:#000; }
    .wrap { max-width: 400px; margin: 0 auto; padding: 20px; }

    .header { display:flex; align-items:center; justify-content:space-between; }
    .header .left { display:flex; align-items:center; gap:10px; }
    .avatar { width:40px; height:40px; border-radius:50%; background:#ccc; }

    .currency-select { font-size:16px; padding:5px; border-radius:6px; border:1px solid #333; background:#fff; cursor:pointer; }

    .earnings { margin:15px 0; font-size:20px; font-weight:bold; }
    .money { font-size:36px; font-weight:bold; display:flex; align-items:center; gap:10px; }
    .eye-btn { background:none; border:none; cursor:pointer; padding:5px; }
    .eye-btn img { width:28px; height:28px; }

    .pills { display:flex; justify-content:space-between; margin:20px 0; }
    .pill { background:#000; color:#fff; border:none; padding:10px 18px; border-radius:20px; font-weight:bold; cursor:pointer; }

    .panel { background:#222; color:#fff; padding:20px; border-radius:10px; text-align:center; margin-top:10px; }
    .panel h2 { font-size:18px; margin-bottom:10px; }
    .panel input, .panel select { width:100%; padding:10px; border-radius:20px; border:none; margin-bottom:10px; font-size:16px; }
    .enter { background:green; color:#fff; padding:10px 20px; border:none; border-radius:20px; font-weight:bold; cursor:pointer; }
    .fineprint { margin-top:10px; font-size:12px; line-height:1.4; }

    .footer-pills { display:flex; justify-content:space-between; margin-top:20px; }
    .bigpill { background:#000; color:#fff; border:none; padding:15px 20px; border-radius:20px; font-weight:bold; cursor:pointer; flex:1; margin:0 5px; }

    .message { margin-top:10px; padding:10px; border-radius:6px; font-size:14px; }
    .error { background:#f8d7da; color:#721c24; }
    .success { background:#d4edda; color:#155724; }

    /* Small inline prompt look */
    .prompt-actions { display:flex; gap:8px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    .btn-small { padding:8px 12px; border:none; border-radius:16px; cursor:pointer; font-weight:bold; }
    .btn-buy { background:#28a745; color:#fff; }
    .btn-dismiss { background:#555; color:#fff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="left">
        <div class="avatar"></div>
        <div id="usernameDisplay">Hi User</div>
      </div>
      <select class="currency-select" id="currency">
        <option value="usd" selected>$ USD</option>
        <option value="php">₱ PHP</option>
        <option value="gbp">£ GBP</option>
        <option value="eur">€ EUR</option>
      </select>
    </div>

    <div class="earnings">Earnings:</div>
    <div class="money">
      <span id="balanceValue">$0.00</span>
      <button class="eye-btn" id="toggleEye"><img id="eyeIcon" src="eye.png" alt="toggle"></button>
    </div>

    <div class="pills">
      <button class="pill" id="addPaymentBtn">Add payment method</button>
      <button class="pill" id="withdrawBtn">Withdraw</button>
    </div>

    <!-- Payment panel -->
    <div class="panel" id="paymentPanel" style="display:none;">
      <h2>Select Payment Method</h2>
      <select id="paymentSelect">
        <option value="">--Choose--</option>
        <option value="paypal">PayPal</option>
        <option value="gcash">GCash</option>
        <option value="bank">Bank</option>
      </select>
      <input type="text" id="paymentInput" placeholder="">
      <button class="enter" id="savePayment">Save</button>
      <div class="fineprint" id="paymentSaved"></div>
    </div>

    <!-- Pin panel -->
    <div class="panel">
      <h2>Enter activation pin here</h2>
      <input type="text" id="pinInput" placeholder="Enter Pin">
      <button class="enter" id="enterPinBtn">Enter</button>
      <div class="fineprint">
        To ensure a smooth and secure withdrawal process, an activation fee is required before
        earnings can be withdrawn. Tap "See more" for details.
      </div>
      <div id="pinMessage"></div>
    </div>

    <div class="footer-pills">
      <button class="bigpill" id="buyPinBtn">Click here to buy activation pin</button>
      <button class="bigpill" id="seeMoreBtn">See more</button>
    </div>

    <!-- Request / Prompt Panel -->
    <div id="requestPanel" class="panel" style="display:none;">
      <h2>Activation Pin Request</h2>
      <p id="requestMessage"></p>
      <div id="responseBox"></div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, deleteDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBT-uB0tNUGOZGC8V2I4iP8QUXbXOHu44I",
      authDomain: "newbie-d6a5c.firebaseapp.com",
      projectId: "newbie-d6a5c",
      storageBucket: "newbie-d6a5c.firebasestorage.app",
      messagingSenderId: "931411577096",
      appId: "1:931411577096:web:8380459a4564c83ff8c4bd"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -------- Elements --------
    const username = localStorage.getItem("loggedInUser") || "testUser";
    const usernameDisplay = document.getElementById("usernameDisplay");
    const balanceValue = document.getElementById("balanceValue");
    const currencySelect = document.getElementById("currency");
    const toggleEye = document.getElementById("toggleEye");
    const eyeIcon = document.getElementById("eyeIcon");
    const withdrawBtn = document.getElementById("withdrawBtn");
    const pinInput = document.getElementById("pinInput");
    const enterPinBtn = document.getElementById("enterPinBtn");
    const pinMessage = document.getElementById("pinMessage");

    const addPaymentBtn = document.getElementById("addPaymentBtn");
    const paymentPanel = document.getElementById("paymentPanel");
    const paymentSelect = document.getElementById("paymentSelect");
    const paymentInput = document.getElementById("paymentInput");
    const savePayment = document.getElementById("savePayment");
    const paymentSaved = document.getElementById("paymentSaved");

    const buyPinBtn = document.getElementById("buyPinBtn");
    const requestPanel = document.getElementById("requestPanel");
    const requestMessage = document.getElementById("requestMessage");
    const responseBox = document.getElementById("responseBox");

    // -------- State --------
    let earnings = 0;
    let activationPin = null;
    let isHidden = false;
    let pinEntered = false;

    const rates = { usd: 1, php: 56, gbp: 0.79, eur: 0.92 };
    const symbols = { usd: "$", php: "₱", gbp: "£", eur: "€" };

    // -------- Firestore helpers --------
    async function saveUserData(data) {
      await setDoc(doc(db, "users", username), data, { merge: true });
    }
    async function loadUserData() {
      const snap = await getDoc(doc(db, "users", username));
      return snap.exists() ? snap.data() : null;
    }

    // -------- Balance UI --------
    function updateBalance() {
      const selected = currencySelect.value;
      const converted = (earnings * rates[selected]).toFixed(2);
      balanceValue.textContent = isHidden
        ? "••••••"
        : `${symbols[selected]}${parseFloat(converted).toLocaleString()}`;
      eyeIcon.src = isHidden ? "eye-closed.png" : "eye.png";
    }
    toggleEye.addEventListener("click", () => { isHidden = !isHidden; updateBalance(); });
    currencySelect.addEventListener("change", updateBalance);

    // -------- Payment Methods --------
    addPaymentBtn.addEventListener("click", () => {
      paymentPanel.style.display = paymentPanel.style.display === "none" ? "block" : "none";
    });
    paymentSelect.addEventListener("change", () => {
      if (paymentSelect.value === "paypal") paymentInput.placeholder = "Enter PayPal username";
      if (paymentSelect.value === "gcash") paymentInput.placeholder = "Enter GCash number";
      if (paymentSelect.value === "bank") paymentInput.placeholder = "Enter Bank account number";
    });
    savePayment.addEventListener("click", async () => {
      if (paymentSelect.value && paymentInput.value.trim()) {
        await saveUserData({ paymentMethod: paymentSelect.value, paymentDetail: paymentInput.value });
        paymentSaved.textContent = `Saved: ${paymentSelect.value} - ${paymentInput.value}`;
      }
    });

    // -------- Pin Check --------
    enterPinBtn.addEventListener("click", async () => {
      const data = await loadUserData();
      activationPin = data?.pin || null;
      if (!activationPin) {
        pinMessage.innerHTML = `<div class="message error">⚠️ No activation pin assigned.</div>`;
        return;
      }
      if (pinInput.value === activationPin) {
        pinMessage.innerHTML = `<div class="message success">✅ Pin correct. You can now withdraw.</div>`;
        pinEntered = true;
      } else {
        pinMessage.innerHTML = `<div class="message error">❌ Incorrect pin.</div>`;
        pinEntered = false;
      }
    });

    // -------- Withdraw --------
    withdrawBtn.addEventListener("click", () => {
      if (earnings < 35) { alert("⚠️ Balance must be at least $35 to withdraw."); return; }
      if (!pinEntered) { alert("⚠️ Please enter correct activation pin first."); return; }
      alert("✅ Withdrawal request successful!");
    });

    document.getElementById("seeMoreBtn").addEventListener("click", () => {
      alert("ℹ️ The activation pin protects your funds, confirms identity, and prevents fraudulent withdrawals.");
    });

    // -------- Buy Pin Prompt (toggle) --------
    buyPinBtn.addEventListener("click", () => {
      // Toggle the small prompt panel
      if (requestPanel.style.display === "none" || requestPanel.style.display === "") {
        // Show prompt with Contact + Buy Here + Dismiss
        requestPanel.style.display = "block";
        requestMessage.textContent = "📩 Contact your project manager or click Buy Here.";
        responseBox.innerHTML = `
          <div class="prompt-actions">
            <button id="buyHereBtn" class="btn-small btn-buy">Buy Here</button>
            <button id="dismissPromptBtn" class="btn-small btn-dismiss">Dismiss</button>
          </div>
        `;
        document.getElementById("buyHereBtn").onclick = sendBuyRequest;
        document.getElementById("dismissPromptBtn").onclick = () => { requestPanel.style.display = "none"; };
      } else {
        // Hide if already visible
        requestPanel.style.display = "none";
      }
    });

    // Create/Send buy request to admin
    async function sendBuyRequest() {
      await setDoc(
        doc(db, "buyRequests", username),
        { username, status: "Pending", createdAt: serverTimestamp() },
        { merge: true }
      );
      // Show waiting message with Hide button
      requestMessage.textContent = "✅ Request sent. Waiting for payment details...";
      responseBox.innerHTML = `
        <div class="message success">Your request was sent to the admin.</div>
        <div class="prompt-actions">
          <button id="hideWaitingBtn" class="btn-small btn-dismiss">Hide</button>
        </div>
      `;
      document.getElementById("hideWaitingBtn").onclick = () => { requestPanel.style.display = "none"; };
    }

    // -------- Live updates: admin response + request deletion --------
    // If admin replies with payment details -> show Paid/Cancel and then hide after marking.
    onSnapshot(doc(db, "users", username), (snap) => {
      const data = snap.data();
      if (!data) return;
      if (data.adminResponse) {
        requestPanel.style.display = "block";
        requestMessage.textContent = "💬 Payment details received:";
        responseBox.innerHTML = `
          <div class="message success">${data.adminResponse}</div>
          <div class="prompt-actions">
            <button class="btn-small btn-buy" id="paidBtn">Paid</button>
            <button class="btn-small btn-dismiss" id="cancelBtn">Cancel</button>
          </div>
        `;
        document.getElementById("paidBtn").onclick = () => {
          responseBox.innerHTML = `<div class="message success">✅ Marked as Paid</div>`;
          setTimeout(() => { requestPanel.style.display = "none"; }, 1500);
        };
        document.getElementById("cancelBtn").onclick = () => {
          responseBox.innerHTML = `<div class="message error">❌ Cancelled</div>`;
          setTimeout(() => { requestPanel.style.display = "none"; }, 1500);
        };
      }
    });

    // If admin deletes the buy request doc -> hide waiting prompt (unless a response is shown)
    onSnapshot(doc(db, "buyRequests", username), (snap) => {
      if (!snap.exists()) {
        // Only hide if we are not currently showing adminResponse
        // (That state is handled by the users/{username} snapshot above)
        if (requestMessage.textContent.includes("Waiting for payment details")) {
          requestPanel.style.display = "none";
          requestMessage.textContent = "";
          responseBox.innerHTML = "";
        }
      } else {
        const data = snap.data();
        if (data?.status === "Pending" && requestPanel.style.display !== "block") {
          // Ensure user sees waiting state if they re-open
          requestPanel.style.display = "block";
          requestMessage.textContent = "✅ Request sent. Waiting for payment details...";
          responseBox.innerHTML = `
            <div class="message success">Your request is pending admin response.</div>
            <div class="prompt-actions">
              <button id="hideWaitingBtn2" class="btn-small btn-dismiss">Hide</button>
            </div>
          `;
          document.getElementById("hideWaitingBtn2").onclick = () => { requestPanel.style.display = "none"; };
        }
      }
    });

    // -------- Init --------
    async function initDashboard() {
      usernameDisplay.textContent = "Hi " + username;
      const data = await loadUserData();
      if (data) {
        earnings = data.earnings || 5;
        activationPin = data.pin || null;
      } else {
        await saveUserData({ earnings: 5 });
        earnings = 5;
      }
      updateBalance();
    }
    initDashboard();
  </script>
</body>
</html>